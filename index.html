<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Hub (Debug Mode)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
</head>
<body class="bg-gray-100 h-screen flex flex-col font-sans">

    <div class="bg-indigo-700 p-4 text-white shadow-lg flex justify-between items-center z-10">
        <h1 class="font-bold text-lg"><i class="fa-solid fa-graduation-cap"></i> Student Hub</h1>
        <button onclick="testConnection()" class="bg-red-500 text-white text-xs px-2 py-1 rounded font-bold border border-red-700 hover:bg-red-600">
             Test System üõ†Ô∏è
        </button>
    </div>

    <div id="debug-log" class="hidden bg-black text-green-400 text-xs p-2 font-mono h-24 overflow-y-scroll border-b-4 border-red-500">
        > System Ready...
    </div>

    <div class="flex-1 flex flex-col overflow-hidden relative">
        <div id="message-container" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50">
            <div class="text-center text-gray-400 text-xs mt-4">Welcome to Class Chat üëã</div>
        </div>

        <div class="p-3 bg-white border-t shadow-lg flex gap-2 items-center">
            <input id="chat-username" type="text" placeholder="Name" class="w-20 p-2 border rounded-lg text-sm bg-gray-50">
            <input id="chat-input" type="text" placeholder="Type a message..." class="flex-1 p-2 border rounded-lg text-sm bg-gray-50">
            <button onclick="sendChatMessage()" class="bg-indigo-600 text-white w-10 h-10 rounded-lg shadow-md">
                <i class="fa-solid fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // ‚ö†Ô∏è PASTE KEYS HERE ‚ö†Ô∏è
        const SUPABASE_URL = "https://ckzvfupbktfbaokidces.supabase.co";
        const SUPABASE_KEY = "sb_publishable_nTq7kpOXsswlpTRl5KfdrA_jZk2XWrB";
        const GEMINI_KEY =   "AIzaSyD82G4kQE9rqYA5L69yyr5gWo49R5Sr6f4";

        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- 1. SYSTEM TEST (Click the Red Button) ---
        window.testConnection = async function() {
            const log = document.getElementById('debug-log');
            log.classList.remove('hidden');
            log.innerHTML += "<br>> Testing Supabase Connection...";
            
            // Check Messages Table
            const { data, error } = await supabase.from('messages').select('*').limit(1);
            if(error) {
                alert("‚ùå SUPABASE ERROR:\n" + error.message + "\n\nHint: Check RLS or Table Name.");
                log.innerHTML += "<br>> ‚ùå Supabase Failed: " + error.message;
            } else {
                alert("‚úÖ Supabase Connected!\nTable 'messages' found.");
                log.innerHTML += "<br>> ‚úÖ Supabase OK.";
            }

            // Check AI Key
            if(GEMINI_KEY.includes("PASTE") || GEMINI_KEY.length < 10) {
                 log.innerHTML += "<br>> ‚ö†Ô∏è Gemini Key looks wrong.";
                 alert("‚ö†Ô∏è Gemini Key is missing or invalid.");
            }
        }

        // --- 2. SEND MESSAGE (Fixed) ---
        window.sendChatMessage = async function() {
            const username = document.getElementById('chat-username').value.trim() || "Student";
            const content = document.getElementById('chat-input').value.trim();
            if (!content) return;

            try {
                // 1. Try to check ban status (Safe Mode)
                // If table is missing, we ignore the error and let them chat anyway
                const { data: banned, error: banError } = await supabase
                    .from('banned_users')
                    .select('*')
                    .eq('name', username)
                    .single();
                
                if (banned) {
                    alert("üö´ You are banned.");
                    return;
                }
            } catch (err) {
                console.log("Ban check skipped (Table might be missing)");
            }

            // 2. Send Message
            const { error } = await supabase
                .from('messages')
                .insert([{ username: username, content: content }]);

            if (error) {
                alert("‚ùå Send Failed: " + error.message); // SHOW ERROR ON SCREEN
            } else {
                document.getElementById('chat-input').value = "";
            }
        }

        // --- 3. REALTIME LISTENER ---
        const channel = supabase
            .channel('public:messages')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
                displayMessage(payload.new);
            })
            .subscribe((status) => {
                if(status === 'SUBSCRIBED') {
                    console.log("Realtime Connected");
                }
            });

        // Load old messages
        async function loadMessages() {
            const { data, error } = await supabase.from('messages').select('*').order('created_at', { ascending: true }).limit(50);
            if(data) data.forEach(msg => displayMessage(msg));
            if(error) document.getElementById('debug-log').innerHTML += "<br>> Load Error: " + error.message;
        }

        function displayMessage(msg) {
            const container = document.getElementById('message-container');
            const myName = document.getElementById('chat-username').value || "Student";
            const isMe = msg.username === myName;
            
            const html = `
                <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'}">
                    <span class="text-[10px] text-gray-400 px-1">${msg.username}</span>
                    <div class="${isMe ? 'bg-indigo-600 text-white' : 'bg-white text-gray-800 border'} px-4 py-2 rounded-2xl text-sm max-w-[85%]">
                        ${msg.content}
                    </div>
                </div>`;
            container.insertAdjacentHTML('beforeend', html);
            container.scrollTop = container.scrollHeight;
        }

        loadMessages();
    </script>
</body>
</html>



